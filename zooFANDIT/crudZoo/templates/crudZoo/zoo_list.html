<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Listado de Zoológicos</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #f7f7f7;
        margin: 20px;
    }

    h1 {
        color: #2c3e50;
    }

    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        margin: 4px 2px;
        font-weight: bold;
    }

    .btn-success { background-color: #27ae60; color: white; }
    .btn-edit { background-color: #2980b9; color: white; }
    .btn-delete { background-color: #c0392b; color: white; }

    .zoo-list { list-style: none; padding: 0; }
    .zoo-item {
        background: white;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .zoo-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .zoo-header h2 {
        margin: 0;
        font-size: 1.2em;
    }

    .animal-list {
        margin-top: 8px;
        padding-left: 20px;
    }

    .animal-list li {
        margin-bottom: 4px;
    }

    #deleteModal {
        display: none;
        position: fixed;
        top:0;
        left:0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    #deleteModal .modal-content {
        background: white;
        padding: 24px;
        border-radius: 8px;
        max-width: 400px;
        text-align: center;
    }

    #deleteModal button {
        margin: 8px;
    }
</style>
</head>
<body>

<h1>Listado de Zoológicos</h1>

<button onclick="window.location.href='{% url 'zoo-create' %}'" class="btn btn-success">
    Crear Nuevo Zoo
</button>

<ul class="zoo-list">
{% for item in zoo_data %}
    <li id="zoo-{{ item.zoo.id }}" class="zoo-item">
        <div class="zoo-header">
            <h2>{{ item.zoo.name }} - {{ item.zoo.city }}, {{ item.zoo.country }}</h2>
            <div>
                <button class="btn btn-edit" onclick="window.location.href='{% url 'zoo-edit' item.zoo.id %}'">Editar</button>
                <button class="btn btn-delete" onclick="confirmDelete('{{ item.zoo.id }}', '{{ item.zoo.name|escapejs }}')">Eliminar</button>
            </div>
        </div>
        <p>Animales: {{ item.animal_count }}</p>
        <ul class="animal-list">
            {% for family, animals in item.animals_by_family.items %}
                <li><strong>{{ family }}</strong>: {{ animals|join:", " }}</li>
            {% endfor %}
        </ul>
    </li>
{% endfor %}
</ul>

<div id="deleteModal">
    <div class="modal-content">
        <h3 id="modalTitle"></h3>
        <p>¿Seguro que deseas eliminar este zoo?</p>
        <button id="confirmBtn" class="btn btn-delete">Sí, eliminar</button>
        <button id="cancelBtn" class="btn btn-edit">Cancelar</button>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    let zooToDelete = null;
    const modal = document.getElementById('deleteModal');
    const modalTitle = document.getElementById('modalTitle');
    const confirmBtn = document.getElementById('confirmBtn');
    const cancelBtn = document.getElementById('cancelBtn');

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.slice(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    window.confirmDelete = function(zooId, zooName) {
        zooToDelete = zooId;
        modalTitle.innerText = `Eliminar: ${zooName}`;
        modal.style.display = 'flex';
    }

    function closeModal() {
        modal.style.display = 'none';
        zooToDelete = null;
    }

    cancelBtn.addEventListener('click', closeModal);

    confirmBtn.addEventListener('click', async function() {
        if (!zooToDelete) return;

        try {
            const res = await fetch(`/${zooToDelete}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            if (res.ok) {
                document.getElementById(`zoo-${zooToDelete}`).remove();
                closeModal();
            } else {
                alert('Error al eliminar el zoo');
            }
        } catch (err) {
            alert('Error de red al eliminar: ' + err);
        }
    });
});
</script>

</body>
</html>
