<h1>Listado de Zoológicos</h1>
<a href="{% url 'zoo-create' %}">Crear Nuevo Zoo</a>
<ul>
{% for item in zoo_data %}
    <li id="zoo-{{ item.zoo.id }}">
        <strong>{{ item.zoo.name }}</strong> - {{ item.zoo.city }}, {{ item.zoo.country }}
        <br>
        Animales: {{ item.animal_count }}
        <br>
        <button type="button" onclick="window.location.href='{% url 'zoo-edit' item.zoo.id %}'"> Editar </button>

        <button type="button" onclick="confirmDelete('{{ item.zoo.id }}', '{{ item.zoo.name|escapejs }}')">Eliminar</button>
        <ul>
            {% for family, animals in item.animals_by_family.items %}
                <li>
                    <strong>{{ family }}</strong>: {{ animals|join:", " }}
                </li>
            {% endfor %}
        </ul>
    </li>
{% endfor %}
</ul>

<div id="deleteModal" style="display:none; position:fixed; top:0; left:0; 
     width:100%; height:100%; background:rgba(0,0,0,0.5); 
     justify-content:center; align-items:center;">
    <div style="background:white; padding:20px; border-radius:8px; max-width:400px; margin:auto;">
        <h3 id="modalTitle"></h3>
        <p>¿Seguro que deseas eliminar este zoo?</p>
        <button id="confirmBtn" type="button">Sí, eliminar</button>
        <button id="cancelBtn" type="button">Cancelar</button>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    let zooToDelete = null;

    const modal = document.getElementById('deleteModal');
    const modalTitle = document.getElementById('modalTitle');
    const confirmBtn = document.getElementById('confirmBtn');
    const cancelBtn = document.getElementById('cancelBtn');

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.slice(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    window.confirmDelete = function(zooId, zooName) {
        zooToDelete = zooId;
        modalTitle.innerText = `Eliminar: ${zooName}`;
        modal.style.display = 'flex';
    }

    function closeModal() {
        modal.style.display = 'none';
        zooToDelete = null;
    }

    cancelBtn.addEventListener('click', closeModal);

    confirmBtn.addEventListener('click', async function() {
        if (!zooToDelete) return;

        try {
            const res = await fetch(`/${zooToDelete}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            if (res.ok) {
                document.getElementById(`zoo-${zooToDelete}`).remove();
                closeModal();
            } else {
                alert('Error al eliminar el zoo');
            }
        } catch (err) {
            alert('Error de red al eliminar: ' + err);
        }
    });
});
</script>